<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPIran Fragment Generator</title>
</head>
<body>
    <h1>OPIran subscription Fragment Generator</h1>
    <h2>پس از ایجاد کد با استفاده از فرم بالا، تمام اسکریپت جاوا را کپی کرده و در Cloudflare Worker قرار دهید</h2>
    <h2>یا اگر اعتماد دارید، می توانید کلید api را برای ایجاد worker ایجاد کنید و از deploy در cloudflare استفاده کنید</h2>
    <h2>اکنون دامنه WORKER شما پیوند اشتراک شماست</h2>
    <form id="configForm">

        <label for="cleanIP">Clean IP / Domain:</label>
        <input type="text" id="cleanIP" name="cleanIP" placeholder="e.g., example.com , 1.1.1.1" required><br>
        
        <label for="yourDomain">Your Domain:</label>
        <input type="text" id="yourDomain" name="yourDomain" placeholder="e.g., example.com" required><br>
        
        <label for="port">Port:</label>
        <select id="port" name="port">
            <option value="443">443</option>
            <option value="8443">8443</option>
            <option value="2053">2053</option>
            <option value="2096">2096</option>
            <option value="2087">2087</option>
            <option value="2083">2083</option>
        </select><br>

        <label for="userUUID">User UUID:</label>
        <input type="text" id="userUUID" name="userUUID" placeholder="Enter User UUID" required><br>

        <label for="protocol">Protocol:</label>
        <select id="protocol" name="protocol">
            <option value="vless">VLESS</option>
            <option value="vmess">VMESS</option>
        </select><br>

        <label for="path">Path (Optional):</label>
        <input type="text" id="path" name="path" placeholder="Enter Path"><br>

        <label for="tls">Enable TLS:</label>
        <input type="checkbox" id="tls" name="tls"><br>

        <label for="mux">Enable Mux:</label>
        <input type="checkbox" id="mux" name="mux"><br>

        <label for="block">Block Iran and China domains:</label>
        <input type="checkbox" id="block" name="block"><br>

        <label for="allowInsecure">Allow Insecure:</label>
        <input type="checkbox" id="allowInsecure" name="allowInsecure"><br>

        <label for="allowEarlyData">Allow Early Data:</label>
        <input type="checkbox" id="allowEarlyData" name="allowEarlyData"><br>

        <label for="workerDomain">Cloudflare Worker Domain (Optional):</label>
        <input type="text" id="workerDomain" name="workerdomain" placeholder="your-worker-name.your-subdomain.workers.dev"><br>

        <label for="email">Cloudflare Email (Optional):</label>
        <input type="text" id="email" name="email" placeholder="your-cloudflare-email@example.com"><br>

        <label for="apiKey">Cloudflare API key (worker zone) (Optional):</label>
        <input type="text" id="apiKey" name="apikey" placeholder="your-cloudflare-api-key"><br>
        
        <button type="button" onclick="generateConfig()">Generate Configuration</button>
    </form>

    <pre id="configOutput"></pre>

    <button type="button" onclick="deployToCloudflare()">Deploy on Cloudflare Worker</button>

    <script>
function deployToCloudflare() {
    const configOutput = document.getElementById('configOutput').innerText;

    // Your Cloudflare Worker domain
    const workerDomain = 'your-worker-name.your-subdomain.workers.dev';

    // Your Cloudflare account information
    const email = 'your-cloudflare-email@example.com';
    const apiKey = 'your-cloudflare-api-key';

    // Construct the Cloudflare API URL
    const apiUrl = `https://api.cloudflare.com/client/v4/accounts/self/workers/scripts/${workerDomain}`;

    // Make a fetch request to update the worker script
    fetch(apiUrl, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/javascript',
            'X-Auth-Email': email,
            'X-Auth-Key': apiKey,
        },
        body: configOutput,
    })
    .then(response => {
        if (response.ok) {
            alert('Configuration deployed successfully!');
        } else {
            alert('Failed to deploy configuration. Please check the console for details.');
            console.error('Failed to deploy configuration:', response.statusText);
        }
    })
    .catch(error => {
        alert('An error occurred while deploying the configuration. Please check the console for details.');
        console.error('Error deploying configuration:', error);
    });
}
function generateConfig() {
    const cleanIP = document.getElementById('cleanIP').value;
    const yourDomain = document.getElementById('yourDomain').value;
    const port = document.getElementById('port').value;
    const userUUID = document.getElementById('userUUID').value;
    const path = document.getElementById('path').value;
    const tls = document.getElementById('tls').checked;
    const mux = document.getElementById('mux').checked;
    const block = document.getElementById('block').checked;
    const allowInsecure = document.getElementById('allowInsecure').checked;
    const allowEarlyData = document.getElementById('allowEarlyData').checked;
    const selectedProtocol = document.getElementById('protocol').value;

    // Constants
    const portsList = [443, 8443, 2053, 2096, 2087, 2083];

    // Randomized constants
    const randomizedDomain = yourDomain.toLowerCase().split('').map(char => Math.random() > 0.5 ? char.toUpperCase() : char.toLowerCase()).join('');
    const randomPath = path;

    // Configuration object
    const config = {
        "log": {
            "access": "",
            "error": "",
            "loglevel": "warning"
        },
        "inbounds": [
            {
                "tag": "socks",
                "port": 10808,
                "listen": "127.0.0.1",
                "protocol": "socks",
                "sniffing": {
                    "enabled": true,
                    "destOverride": [
                        "http",
                        "tls"
                    ],
                    "routeOnly": false
                },
                "settings": {
                    "auth": "noauth",
                    "udp": true,
                    "allowTransparent": false
                }
            },
            {
                "tag": "http",
                "port": 10809,
                "listen": "127.0.0.1",
                "protocol": "http",
                "sniffing": {
                    "enabled": true,
                    "destOverride": [
                        "http",
                        "tls"
                    ],
                    "routeOnly": false
                },
                "settings": {
                    "auth": "noauth",
                    "udp": true,
                    "allowTransparent": false
                }
            }
        ],
        "outbounds": [
            {
                "tag": "proxy",
                "protocol": selectedProtocol,
                "settings": {
                    "vnext": [
                        {
                            "address": cleanIP,
                            "port": port,
                            "users": [
                                {
                                    "id": userUUID,
                                    "alterId": 0,
                                    "email": "t@t.tt",
                                    "security": "auto",
                                    "encryption": "none",
                                    "flow": ""
                                }
                            ]
                        }
                    ]
                },
                "streamSettings": {
                    "network": tls ? "ws" : "tcp",
                    "security": tls ? "tls" : "none",
                    "tlsSettings": {
                        "allowInsecure": allowInsecure,
                        "serverName": randomizedDomain,
                        "alpn": [
                            "h2",
                            "http/1.1"
                        ],
                        "fingerprint": "chrome",
                        "show": false
                    },
                    "wsSettings": {
                        "path": randomPath,
                        "headers": {
                            "Host": randomizedDomain
                        }
                    },
                    "sockopt": {
                        "dialerProxy": mux ? "fragment" : "",
                        "tcpKeepAliveIdle": 100,
                        "mark": 255,
                        "tcpNoDelay": true
                    }
                },
                "mux": {
                    "enabled": mux,
                    "concurrency": mux ? 8 : -1  // Set to 8 if mux is enabled, otherwise -1
                }
            },
            {
                "tag": "fragment",
                "protocol": "freedom",
                "settings": {
                    "domainStrategy": "AsIs",
                    "fragment": {
                        "packets": tls ? "tlshello" : "1-1",
                        "length": tls ? "10-20" : "1-3",
                        "interval": tls ? "10-20" : "5"
                    }
                },
                "streamSettings": {
                    "sockopt": {
                        "tcpNoDelay": true,
                        "tcpKeepAliveIdle": 100
                    }
                }
            },
            {
                "tag": "direct",
                "protocol": "freedom",
                "settings": {}
            },
            {
                "tag": "block",
                "protocol": "blackhole",
                "settings": {
                    "response": {
                        "type": "http"
                    }
                }
            }
        ],
        "routing": {
            "domainStrategy": "AsIs",
            "rules": [
                {
                    "type": "field",
                    "inboundTag": [
                        "api"
                    ],
                    "outboundTag": "api",
                    "enabled": true
                },
                {
                    "id": "5465425548310166497",
                    "type": "field",
                    "outboundTag": "direct",
                    "domain": [
                        "domain:ir",
                        "geosite:cn"
                    ],
                    "enabled": true
                },
                {
                    "id": "5425034033205580637",
                    "type": "field",
                    "outboundTag": "direct",
                    "ip": [
                        "geoip:private",
                        "geoip:cn",
                        "geoip:ir"
                    ],
                    "enabled": true
                },
                {
                    "id": "5627785659655799759",
                    "type": "field",
                    "port": "0-65535",
                    "outboundTag": "proxy",
                    "enabled": true
                }
            ]
        }
    };

    // Respond with the JSON configuration
    document.getElementById('configOutput').innerText = JSON.stringify(config, null, 4);

    // Update the copy button text
    const copyButton = document.getElementById('copyButton');
    copyButton.innerText = 'Copy Configuration';
    copyButton.removeAttribute('disabled');
}
        
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Clipboard.js
            new ClipboardJS('#copyButton');

            // Display a message when the copy is successful
            document.getElementById('copyButton').addEventListener('click', function () {
                const copyButton = this;
                copyButton.innerText = 'Copied!';
                copyButton.setAttribute('disabled', 'true');
            });
        });

        // Utility functions
        function generateRandomString(length, characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789') {
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }
    </script>
</body>
</html>
